generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Seed {
  id        Int       @id @default(autoincrement())
  name      String?
  baseUrl   String     @unique   // e.g. "http://192.190.136.36:6000"
  enabled   Boolean    @default(true)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  observations PnodeGossipObservation[]
  statsSamples PnodeStatsSample[]
}

model Pnode {
  id        Int       @id @default(autoincrement())
  pubkey    String?   @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // GLOBAL fetch state for stats (exponential backoff, reachability, etc.)
  reachable          Boolean   @default(false)
  failureCount       Int       @default(0)
  lastStatsAttemptAt DateTime?
  lastStatsSuccessAt DateTime?
  nextStatsAllowedAt DateTime?

  gossipObservations PnodeGossipObservation[]
  statsSamples       PnodeStatsSample[]
}

model PnodeGossipObservation {
  id       Int      @id @default(autoincrement())

  seed     Seed     @relation(fields: [seedId], references: [id])
  seedId   Int

  pnode    Pnode    @relation(fields: [pnodeId], references: [id])
  pnodeId  Int

  address           String    // "ip:port"
  version           String?
  lastSeenTimestamp BigInt?   // raw unix timestamp from gossip (seconds)
  observedAt        DateTime  @default(now())
}

model PnodeStatsSample {
  id       Int      @id @default(autoincrement())

  pnode    Pnode    @relation(fields: [pnodeId], references: [id])
  pnodeId  Int

  seed     Seed?    @relation(fields: [seedId], references: [id])
  seedId   Int?

  timestamp         DateTime @default(now())
  cpuPercent        Float?
  ramUsedBytes      BigInt?
  ramTotalBytes     BigInt?
  uptimeSeconds     Int?
  packetsInPerSec   Float?
  packetsOutPerSec  Float?
  totalBytes        BigInt?
  activeStreams     Int?
}
