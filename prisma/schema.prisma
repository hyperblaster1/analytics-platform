generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Pnode {
  id                Int               @id @default(autoincrement())
  address           String            @unique          // "ip:port" from get-pods
  version           String?                            // pNode version
  pubkey            String?                            // pNode public key
  
  // Gossip timestamps (from get-pods)
  gossipLastSeen          DateTime?                    // derived from last_seen_timestamp (gossip)
  gossipLastSeenTimestamp BigInt?                     // raw unix timestamp from gossip (seconds)
  
  // Stats timestamps (from get-stats)
  lastStatsAttemptAt  DateTime?      // when we last *tried* to call get-stats
  lastStatsSuccessAt  DateTime?      // when get-stats last succeeded
  nextStatsAllowedAt  DateTime?      // earliest time we are allowed to call get-stats again (for backoff)
  
  reachable         Boolean           @default(false)  // pRPC reachability (from get-stats)
  lastError         String?           // optional: store last connection error
  failureCount      Int               @default(0)
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  samples           PnodeStatSample[]
}

model PnodeStatSample {
  id              Int      @id @default(autoincrement())
  pnode           Pnode    @relation(fields: [pnodeId], references: [id])
  pnodeId         Int

  timestamp       DateTime @default(now())  // when this sample was collected

  // CPU / RAM / uptime
  cpuPercent      Float?
  ramUsedBytes    BigInt?
  ramTotalBytes   BigInt?
  uptimeSeconds   Int?

  // Network stats (optional, depends on get-stats payload)
  packetsInPerSec  Float?
  packetsOutPerSec Float?
  activeStreams    Int?

  // Storage / generic counters (optional)
  totalBytes       BigInt?
  totalPages       Int?

  createdAt       DateTime @default(now())
}

